# 帧格式序列检测生成模块设计规范
## 1.设计概述
本规范文件描述了帧格式序列检测与生成模块（Frame Format Sequence Generator）的设计规范和特性要求。如下图所示，该模块旨在检测输入数据流中的特定帧格式，并在检测到目标帧时进行串行输出。
如上框图所示，模块接收到数据输入 `data_in` 后，在模块进行以下处理过程：
1. 输入数据检测: 模块接收并采样输入数据。
2. 帧格式识别: 检测并识别输入数据中的特定帧格式，包括帧头、通道选择字段、数据、CRC 校验字段和帧尾 5 个部分。
3. 解帧与数据提取: 识别帧头、通道选择和帧尾，提取数据部分。
4. CRC 校验: 对提取的数据进行 CRC 校验，确保数据完整性。
    - 如果 CRC 校验成功，数据将被写入异步 FIFO 进行缓存。
    - 如果 CRC 校验失败，模块报告错误并丢弃错误数据。
5. 异步 FIFO 缓存: 提取的数据通过异步 FIFO 进行缓存，提供 FIFO 空、FIFO 满信号状态指示。
6. 数据编码: 从 FIFO 中读取数据，按照格雷码进行编码。
7. 根据通道选择进行串行输出: 编码后的数据根据通道选择的数值，决定在哪个通道进行串行输出
## 2. 功能特性与测试要求
### 2.1 输入数据检测
- 功能描述: 模块应能正确接收并采样输入数据。
- 测试要求:
    - 输入数据应在不同的时钟周期内正确采样。
    - 在不同输入频率下，输入数据的正确性应保持一致。
### 2.2 帧格式识别
- 功能描述: 模块应能检测并识别特定的帧格式，包括帧头、通道选择、数据、CRC 校
验字段和帧尾。
- 帧格式:
    - 帧头:
    `32` 位，取值为 `E0E0E0E0`
    - 通道选择:
    `8` 位, 独热码
    - 数据:
    `N` 位（可变长度，限制在`16` 位到`128` 位之间，按照 Big-Endian 方式输入）
    - CRC 校验字段:
    `16` 位
    - 帧尾:
    `32` 位，取值为 `0E0E0E0E`
- 测试要求:
    - 模块应能检测上述帧格式。
    - 模块应能在连续输入不同的目标帧时，正确检测每一个目标帧。
### 2.3 解帧与数据提取
- 功能描述: 模块应能正确解帧，提取数据并进行 CRC 校验。
- 测试要求:
    - 模块应能正确识别帧头、通道选择和帧尾。
    - 提取帧中的数据部分。
    - 进行 CRC 校验，确保数据完整性。
    - 若 CRC 校验失败，模块应能正确处理并报告错误，不进行编码输出。
### 2.4 异步 FIFO 缓存
- 功能描述: 模块应能将提取的数据通过一个异步 FIFO 进行缓存，并提供 FIFO 空、
FIFO 满信号状态指示。FIFO 的宽度及深度不做限制，由参赛者自行确定。
- 测试要求:
    - FIFO 应能正确缓存提取的数据。
    - 提供 FIFO 空（`fifo_empty`）和 FIFO 满（`fifo_full`）信号状态指示。
    - FIFO 应支持异步读写操作。
### 2.5 数据编码与串行输出
- 功能描述: 模块应能将从 FIFO 中读取的数据按照指定的编码方式进行编码，并根据通
道选择进行串行输出。
- 编码规范: 提取的数据应按照以下方式进行编码：
- 格雷码编码:
- 每个二进制数转换为格雷码，如下所示：

    ---

    #### 二进制数与格雷码对照表

    | 二进制数 | 格雷码   |
    |:--------:|:--------:|
    | 0000     | 0000     |
    | 0001     | 0001     |
    | 0010     | 0011     |
    | 0011     | 0010     |
    | 0100     | 0110     |
    | 0101     | 0111     |
    | 0110     | 0101     |
    | 0111     | 0100     |
    | 1000     | 1100     |
    | 1001     | 1101     |
    | 1010     | 1111     |
    | 1011     | 1110     |
    | 1100     | 1010     |
    | 1101     | 1011     |
    | 1110     | 1001     |
    | 1111     | 1000     |

    ---

    - 数据应按照编码后的格式串行输出，每个位在一个时钟周期内输出。
    - 只有从 FIFO 中读取的数据才进行编码输出。
    - 根据通道选择的数值，决定在哪个通道进行输出。
- 测试要求:
    - 从 FIFO 中读取的数据应按照指定的格雷码编码方式进行正确编码。
    - 编码后的数据应按顺序串行输出。
    - 输出信号应在目标帧解帧并编码完成后正确激活。
    - 输出信号在检测到目标帧并提取数据后的保持时间应符合设计要求（例如，至少保持 `T` 个时钟周期） 。
### 2.6 时序特性
- 功能描述: 模块应在不同的时钟频率下正常工作。
- 测试要求:
    - 模块应在指定的时钟频率范围内（50 MHz 到 100 MHz）正常工作。
### 2.7 错误处理
- 功能描述: 模块应能正确处理输入数据错误和 CRC 校验失败。
- 测试要求:
    - 检测到输入数据错误时，模块应能正确处理并恢复正常工作。错误包括以下几种情况：
        1) 检测到帧头及后续数据，但是没有收到帧尾，需丢弃当前帧
        2) 通道选择数据不正确（非独热码选择 1~8） ，需丢弃当前帧
        3) 接收数据长度超出范围（16~128bit） ，需丢弃当前帧
        4) 检测到 CRC 校验失败时，模块应能报告错误并丢弃当前错误数据，
    - 在以上检测到输入错误/异常情况下，模块对当前错误帧全部数据进行丢弃，不进行编码输出，对下一帧数据要求能够正常输出。
### 2.8 复位功能
- 功能描述: 模块应实现可靠的复位功能。
- 测试要求:
    - 复位信号激活后，状态机和输出信号应恢复到初始状态。
    - 复位后的恢复时间应符合设计要求（例如，不超过`T` 个时钟周期） 。
### 2.9 功能覆盖率
- 功能描述: 模块的功能覆盖率应达到设计要求。
- 测试要求:
    - 模块的每个功能特性应进行详细测试，CRC 校验、异步 FIFO 操作、通道选择、数据编码输出、异常处理等关键功能特性应进行全面测试。
    - 要求根据设计规范指定 testplan, 提取测试点，并设置对应的用例集合，对相关特性进行测试且确保用例 pass
### 2.10 仿真验证
- 功能描述: 使用 VCS 仿真工具对模块进行全面验证。
- 测试要求:
    - 使用 VCS 仿真工具对模块进行功能、时序和边界条件测试。
    - 仿真结果应与设计预期一致，代码覆盖率不低于 95%。
## 3. 输入和输出
### 3.1 输入
- 时钟信号 1 (`clk_in`):
    - 描述: 提供模块输入数据采样所需的时钟脉冲。
    - 作用: 驱动数据采样和帧格式检测。
    - 指标: 时钟频率范围为 50MHz 到 100 MHz。
- 时钟信号 2 (`clk_out`):
    - 描述: 提供异步 FIFO 读取数据所需的时钟脉冲。
    - 作用: 驱动数据编码和串行输出。
    - 指标: 时钟频率范围为 50MHz 到 100 MHz，与 `clk_in` 为同频异步。
- 时钟信号 3 (`clk_out_s`):
    - 描述: 提供对数据进行独热码编码后串行输出所需的时钟脉冲。
    - 作用: 驱动数据串行输出。
    - 指标: 时钟频率为 与 `clk_out` 的 16 倍频。
- 复位信号 (`rst_n`):
    - 描述: 复位模块，初始化状态。
    - 作用: 在检测到异常或需要重新开始时复位模块。
    - 指标: 复位信号应为低电平有效。
- 输入数据 (`data_in_`):
    - 描述: 待检测的输入数据流。
    - 作用: 提供要检测的帧格式数据。
    - 指标: 数据位宽为 16 位，按照 Big-Endian 方式输入。
3.2 输出
- 数据串行输出通道 1~8 (`data_out_ch1~8`):
    - 描述: 通道 1~8 的提取并编码的帧数据串行输出。
    - 作用: 根据提取的通道指示信号选择对应通道，将提取并编码的数据以串行格式输出
    到通道 1~8。
    - 指标: 输出为串行数据流，`clk_out` 的时钟驱动。
- 数据有效信号通道 1~8 (`data_vld_ch1~8`):
    - 描述: 指示通道 1~8 输出数据有效。
    - 作用: 当通道 1~8 输出数据有效时，信号拉高。
    - 指标: 输出为高电平有效。
- FIFO 空信号 (`fifo_empty`):
    - 描述: 指示 FIFO 是否为空。
    - 作用: 当 FIFO 为空时激活。
    - 指标: 输出为高电平有效。
- FIFO 满信号 (`fifo_full`):
    - 描述: 指示 FIFO 是否已满。
    - 作用: 当 FIFO 已满时激活。
    - 指标: 输出为高电平有效。
- CRC 校验结果正确 (`crc_valid`):
    - 描述: 指示 CRC 校验结果。
    - 作用: 在 CRC 校验成功时激活。
    - 指标: 输出为高电平有效，数据 CRC 校验正确输出周期内拉高。
- CRC 校验错误(`crc_err`):
    - 描述: 指示 CRC 校验结果错误。
    - 作用: 在 CRC 校验错误时激活。
    - 指标: 输出为高电平有效，数据 CRC 校验错误周期内拉高。
4. 设计指标
- **帧头**: 32 位。
- **通道选择**: 8 位。
- **数据长度 (`N`)**: 可变长度，限制在`16` 位到`128` 位之间。
- **CRC 校验字段**: 16 位。
- **帧尾**: 32 位。
- **异步 FIFO 读/写时钟频率范围**: 50MHz 到 100 MHz。
- **输串行信号速率**:16*clk_out。